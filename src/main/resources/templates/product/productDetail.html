<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>상품 상세정보 - ShowMate</title>
    <link rel="stylesheet" th:href="@{/css/productDetail.css}"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
</head>

<body>
<div layout:fragment="content">
    <div class="product-detail-container">
        <div class="product-detail-info">
            <!-- 상품 이미지 -->
            <img th:src="@{${productDto.img}}" alt="Product Image" class="product-image"/>

            <!-- 상품 정보 -->
            <div class="product-info">
                <div class="detail-top">
                    <a th:href="'/category='+${productDto.category}">[[${productDto.category.getCategory_value()}]]</a>
                    <button id="likeButton" class="icon-button">
                        <img id="likeIcon" th:src="@{/images/heart-outline.png}" alt="Like" class="icon"/>
                    </button>
                    <button id="shareButton" class="icon-button">
                        <img th:src="@{/images/share.png}" alt="Share" class="icon"/>
                    </button>
                </div>

                <h5 th:text="${productDto.name}">Product Name</h5>
                <!-- Rating -->
                <div class="rating-container">
                    <div id="rating" class="rating" th:data-rate="${productDto.rate}"></div>
                    <span class="rating-count" th:text="${productDto.rate_count}+'개 상품평'"> (0)</span>
                </div>

                <div class="d-flex">
                    <p class="price"><strong> <span id="price" th:text="${productDto.price}">0</span>원</strong></p>
                    <button type="button" class="goto-btn"
                            th:onclick="'location.href=\'https://www.coupang.com/vp/products/\' + ' + ${productDto.id}">사러가기</button>
                </div>
                <p>역대최고가 <strong class="highest-price"><span id="highestPrice" th:text="${productDto.price}">0</span>원</strong></p>
                <p>역대최저가 <strong class="lowest-price"><span id="lowestPrice" th:text="${productDto.price}">0</span>원</strong></p>

                <!-- 알림 받기 -->
                <div class="notification-container">
                    <input type="number" placeholder="가격을 입력하세요" class="notification-input"/>
                    <button class="notification-button">알림 받기</button>
                </div>
            </div>
        </div>

        <!-- 가격 변동 그래프 -->
        <h2>Price History</h2>
        <canvas id="priceChart"></canvas>
    </div>
</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            let liked = [[${isLiked}]]; // 기본값은 Controller에서 보내준 isLiked 값
            const token = $("meta[name='_csrf']").attr("content");
            const header = $("meta[name='_csrf_header']").attr("content");

            const likeButton = document.getElementById('likeButton');
            const likeIcon = document.getElementById('likeIcon');
            let isLoggedIn = [[${isLoggedIn ? 'true' : 'false'}]]; // 문자열로 변환

            // 좋아요 상태에 따라 아이콘 변경
            function updateLikeIcon(isLiked) {
                likeIcon.src = isLiked ? '/images/heart.png' : '/images/heart-outline.png';
            }
            updateLikeIcon(liked); // 아이콘 초기화

            likeButton.addEventListener('click', function() {
                if (isLoggedIn === 'true') {
                    liked = !liked; // 상태 토글
                    updateLikeIcon(liked); // 아이콘 업데이트

                    const paramData = {
                        productId: [[${productDto.id}]],
                        liked: liked
                    };

                    $.ajax({
                        url: "/like",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(paramData),
                        dataType: "json",
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader(header, token);
                        },
                        success: (res) => {
                            if (res.message) { // 좋아요 등록 할 때만 뜨게
                                alert(res.message);
                            }
                        },
                        error: (xhr, status, error) => {
                            console.log("Like Error: ", status, error);
                        }
                    });
                } else {
                    alert("로그인이 필요한 서비스입니다.");
                    const currentUrl = window.location.href;
                    location.href = "/user/login?redirect=" + encodeURIComponent(currentUrl);
                }
            });


            // 공유하기 버튼 기능 (간단히 알림으로 처리)
            const shareButton = document.getElementById('shareButton');
            shareButton.addEventListener('click', function() {
                alert('공유하기 기능이 클릭되었습니다!');
                // 실제 공유 기능은 이곳에 추가
            });

            // 숫자 포맷팅 함수
            function formatNumber(number) {
                return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            // 가격 포맷팅
            const priceElement = document.getElementById('price');
            const highestPriceElement = document.getElementById('highestPrice');
            const lowestPriceElement = document.getElementById('lowestPrice');

            if (priceElement) {
                priceElement.textContent = formatNumber(parseInt(priceElement.textContent.replace(/,/g, ''), 10));
            }
            if (highestPriceElement) {
                highestPriceElement.textContent = formatNumber(parseInt(highestPriceElement.textContent.replace(/,/g, ''), 10));
            }
            if (lowestPriceElement) {
                lowestPriceElement.textContent = formatNumber(parseInt(lowestPriceElement.textContent.replace(/,/g, ''), 10));
            }

            // 별점 처리
            const ratingElement = document.getElementById('rating');
            const rate = parseFloat(ratingElement.getAttribute('data-rate'));
            const fullStars = Math.floor(rate);
            const halfStar = rate % 1 !== 0;

            for (let i = 0; i < 5; i++) {
                const starElement = document.createElement('div');
                starElement.classList.add('star');

                if (i < fullStars) {
                    starElement.classList.add('full');
                } else if (i === fullStars && halfStar) {
                    starElement.classList.add('half');
                }

                ratingElement.appendChild(starElement);
            }

            // 가격 히스토리 그래프
            const priceHistories = /*[[${productDto.priceHistoryDto}]]*/ [];

            const dates = priceHistories.map(history => history.date);
            const prices = priceHistories.map(history => history.price);

            const ctx = document.getElementById('priceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Price',
                        data: prices,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'YYYY-MM-DD',
                                displayFormats: {
                                    day: 'YYYY-MM-DD'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(tooltipItem) {
                                    return 'Price: ' + tooltipItem.formattedValue + ' 원';
                                }
                            }
                        }
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true,
                        axis: 'x'
                    }
                }
            });
        });
    </script>
</th:block>
</body>
</html>
